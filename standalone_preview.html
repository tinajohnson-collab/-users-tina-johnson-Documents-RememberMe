<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RememberMe - Standalone Preview</title>
    <!-- React & ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons (We'll mock these components since we can't easily import from CDN in standalone without build step, 
         actually we can render SVGs directly to avoid dependency issues for this preview) -->

    <style>
        /* Minimalist Setup (Copied from index.css) */
        :root {
            font-family: Inter, system-ui, Avenir, Helvetica, Arial, sans-serif;
            line-height: 1.5;
            font-weight: 400;
            color-scheme: light;
            color: #2D3436;
            background-color: #F5F6FA;
        }

        body {
            margin: 0;
            display: flex;
            place-items: center;
            min-width: 320px;
            min-height: 100vh;
        }

        #root {
            width: 100%;
            max-width: 1280px;
            margin: 0 auto;
            text-align: center;
        }

        /* App Styles */
        .app-container {
            max-width: 600px;
            margin: 40px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .minimal-header {
            padding: 20px 30px;
            background: white;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #F5F6FA;
        }

        .minimal-header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: #2D3436;
            letter-spacing: -0.5px;
        }

        .shield-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            background: #e3fcef;
            color: #00b894;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .main-content {
            padding: 30px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .input-card {
            background: white;
            border: 2px solid #F0F2F5;
            border-radius: 16px;
            padding: 20px;
            transition: all 0.2s;
        }

        .input-card:focus-within {
            border-color: #0984e3;
            box-shadow: 0 4px 12px rgba(9, 132, 227, 0.1);
        }

        textarea {
            width: 100%;
            border: none;
            font-family: inherit;
            font-size: 1.1rem;
            resize: none;
            outline: none;
            color: #2D3436;
            background: transparent;
        }

        textarea::placeholder {
            color: #B2BEC3;
        }

        .action-bar {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            border-radius: 8px;
            border: none;
            padding: 0.8em 1.2em;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:active {
            transform: scale(0.98);
        }

        .primary-btn {
            background-color: #0984e3;
            color: white;
            margin-left: auto;
        }

        .icon-btn {
            background-color: #F5F6FA;
            color: #636E72;
        }

        .icon-btn:hover {
            background-color: #dfe6e9;
        }

        .reminder-list {
            margin-top: 40px;
            text-align: left;
        }

        .reminder-card {
            background: white;
            border-left: 4px solid #00b894;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
            animation: slideIn 0.3s ease-out;
        }

        .reminder-card.rescheduled {
            border-left-color: #fdcb6e;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: #636E72;
        }

        .status-badge {
            text-transform: uppercase;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .reminder-text {
            font-size: 1.1rem;
            margin: 0;
            font-weight: 500;
        }

        .ai-notice {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #0984e3;
            background: #e1f5fe;
            padding: 8px;
            border-radius: 6px;
        }

        .meta-info {
            font-size: 0.75rem;
            color: #b2bec3;
            margin-top: 5px;
        }

        .shield-alert {
            background: #ffeaa7;
            border: 1px solid #fdcb6e;
            color: #d63031;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(253, 203, 110, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(253, 203, 110, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(253, 203, 110, 0);
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- ICONS (SVG Mocks for Standalone) ---
        const Mic = ({ size, color }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" /><path d="M19 10v2a7 7 0 0 1-14 0v-2" /><line x1="12" y1="19" x2="12" y2="23" /><line x1="8" y1="23" x2="16" y2="23" /></svg>;
        const ImageIcon = ({ size }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><circle cx="8.5" cy="8.5" r="1.5" /><polyline points="21 15 16 10 5 21" /></svg>;
        const Send = ({ size }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></svg>;
        const ShieldCheck = ({ size, color }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /><circle cx="12" cy="12" r="3" /></svg>; // Simplified shield
        const CheckCircle = ({ size }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></svg>;
        const Settings = ({ size }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></svg>;
        const ExternalLink = ({ size }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></svg>;
        const Bell = ({ size }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" /><path d="M13.73 21a2 2 0 0 1-3.46 0" /></svg>;


        // --- MOCK SERVICES (COPIED FROM mockServices.js) ---
        async function mockAIProcessInput(text) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve({
                        id: Date.now(),
                        text: text,
                        time: "Tomorrow at 10:00 AM",
                        status: "scheduled",
                        confidence: 0.98,
                        attempt_count: 0,
                        last_contact: Date.now(),
                        confirmation_status: 'pending'
                    });
                }, 800);
            });
        }

        async function mockCalendarAPI(reminderData) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve({
                        gcal_id: `gcal_evt_${Math.floor(Math.random() * 10000)}`,
                        synced: true
                    });
                }, 1000);
            });
        }

        function cognitiveLoadShield(reminders) {
            const notifications = [];
            reminders.forEach(r => {
                if (r.confirmation_status === 'no-response' && r.attempt_count >= 3 && r.status !== 'intervention_handled') {
                    notifications.push({
                        type: 'intervention_required',
                        reminderId: r.id,
                        message: `Patient for "${r.text}" failed to respond after 3 attempts. Manual intervention required.`
                    });
                }
            });
            return notifications;
        }

        async function sendToNtfy(message) {
            const topic = 'rememberme_therapist_shield';
            try {
                await fetch(`https://ntfy.sh/${topic}`, {
                    method: 'POST',
                    body: message,
                    headers: {
                        'Title': 'Cognitive Shield Alert',
                        'Priority': 'high',
                        'Tags': 'shield,warning'
                    }
                });
                console.log(`[Real API] Sent notification to ntfy.sh/${topic}`);
            } catch (error) {
                console.error("[Real API] Failed to send notification:", error);
            }
        }


        // --- APP COMPONENT (COPIED FROM App.jsx) ---

        function App() {
            const [input, setInput] = React.useState('');
            const [reminders, setReminders] = React.useState([]);
            const [isProcessing, setIsProcessing] = React.useState(false);
            const [therapistNotifications, setTherapistNotifications] = React.useState([]);
            const [isListening, setIsListening] = React.useState(false);
            const [showSettings, setShowSettings] = React.useState(false);

            const user = { id: 'u1', name: 'Dr. Smith', role: 'therapist' };

            let recognition = null;
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.interimResults = false;
                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    setInput(prev => prev + ' ' + transcript);
                };
            }

            React.useEffect(() => {
                const interval = setInterval(() => {
                    setReminders(prev => prev.map(r => {
                        if (r.status === 'scheduled' && Math.random() < 0.1 && !r.ai_action) {
                            return {
                                ...r,
                                status: 'rescheduled',
                                ai_action: 'Patient requested change. AI found open slot: Next Tuesday 10am.'
                            };
                        }
                        if (r.status !== 'confirmed' && r.attempt_count < 3 && Math.random() < 0.2) {
                            return { ...r, attempt_count: r.attempt_count + 1, confirmation_status: 'no-response' };
                        }
                        return r;
                    }));

                    const alerts = cognitiveLoadShield(reminders);
                    if (alerts.length > 0) {
                        // Filter alerts that haven't been sent to API yet
                        const newAlerts = alerts.filter(a => {
                            const r = reminders.find(rem => rem.id === a.reminderId);
                            return r && !r.alertSent;
                        });

                        if (newAlerts.length > 0) {
                            setTherapistNotifications(alerts);

                            newAlerts.forEach(alert => {
                                // 1. Audio
                                if ('speechSynthesis' in window) {
                                    const utterance = new SpeechSynthesisUtterance("Attention. Therapist intervention required.");
                                    window.speechSynthesis.speak(utterance);
                                }
                                // 2. Real API
                                sendToNtfy(alert.message);
                            });

                            setReminders(prev => prev.map(r =>
                                newAlerts.some(a => a.reminderId === r.id) ? { ...r, alertSent: true } : r
                            ));
                        }
                    }
                }, 5000); // Speed up simulation loop for demo
                return () => clearInterval(interval);
            }, [reminders]);

            const handleVoiceInput = () => {
                if (!recognition) {
                    alert("Voice recognition not supported in this browser.");
                    return;
                }
                recognition.start();
            };

            const handleTestPush = () => {
                sendToNtfy("This is a TEST alert from RememberMe.");
                alert("Test notification sent to ntfy.sh/rememberme_therapist_shield");
            };

            const handleResolve = (reminderId) => {
                // Mark reminder as handled so it doesn't trigger shield again
                setReminders(prev => prev.map(r =>
                    r.id === reminderId ? { ...r, status: 'intervention_handled' } : r
                ));
                // Stop audio if playing
                window.speechSynthesis.cancel();
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!input.trim()) return;
                setIsProcessing(true);
                const processed = await mockAIProcessInput(input);
                const calEvent = await mockCalendarAPI(processed);
                setReminders(prev => [{ ...processed, ...calEvent }, ...prev]);
                setInput('');
                setIsProcessing(false);
            };

            return (
                <div className="app-container">
                    <header className="minimal-header">
                        <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                            <h1>RememberMe</h1>
                            {user.role === 'therapist' && (
                                <div className="shield-badge">
                                    <ShieldCheck size={20} color={therapistNotifications.length > 0 ? "red" : "#4CAF50"} />
                                    <span>Shield Active</span>
                                </div>
                            )}
                        </div>
                        <button
                            onClick={() => setShowSettings(!showSettings)}
                            style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#636E72' }}>
                            <Settings size={24} />
                        </button>
                    </header>

                    {/* SETTINGS MODAL */}
                    {showSettings && (
                        <div style={{
                            marginBottom: '20px', padding: '20px', background: '#F8F9FA', borderRadius: '12px', border: '1px solid #dfe6e9', animation: 'fadeIn 0.3s'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                <h3 style={{ margin: 0 }}>Backend Connections</h3>
                                <button onClick={() => setShowSettings(false)} style={{ border: 'none', background: 'none', fontSize: '1.2rem', cursor: 'pointer' }}>√ó</button>
                            </div>

                            <div style={{ display: 'grid', gap: '15px' }}>
                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '10px', background: 'white', borderRadius: '8px', border: '1px solid #eee' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                        <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: '#00b894' }}></div>
                                        <span>Google Calendar API</span>
                                    </div>
                                    <span style={{ fontSize: '0.8rem', color: '#b2bec3' }}>Simulated (mockServices.js)</span>
                                </div>

                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '10px', background: 'white', borderRadius: '8px', border: '1px solid #eee' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                        <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: '#00b894' }}></div>
                                        <span>Notification Shield (ntfy.sh)</span>
                                    </div>
                                    <span style={{ fontSize: '0.8rem', color: '#b2bec3' }}>Active</span>
                                </div>

                                <div style={{ marginTop: '10px', display: 'flex', gap: '10px' }}>
                                    <button
                                        onClick={handleTestPush}
                                        style={{
                                            flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px',
                                            padding: '10px', background: '#2d3436', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer'
                                        }}>
                                        <Bell size={16} /> Test Real Push
                                    </button>
                                    <a
                                        href="https://calendar.google.com" target="_blank" rel="noreferrer"
                                        style={{
                                            flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px',
                                            padding: '10px', background: 'white', color: '#2d3436', border: '1px solid #2d3436', borderRadius: '8px', textDecoration: 'none', fontSize: '0.9rem'
                                        }}>
                                        <ExternalLink size={16} /> Open Calendar
                                    </a>
                                </div>
                            </div>
                        </div>
                    )}

                    <main className="main-content">
                        <div className="input-card">
                            <label className="input-label" style={{ display: 'block', marginBottom: '10px', color: '#2D3436', fontWeight: '600' }}>
                                Schedule Patient / New Reminder
                            </label>
                            <p style={{ fontSize: '0.9rem', color: '#636E72', marginBottom: '15px' }}>
                                Type natural instructions below. The system will auto-schedule and track confirmations.
                            </p>
                            <form onSubmit={handleSubmit}>
                                <textarea
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    placeholder="e.g. Follow up with John Doe next Tuesday about his medication..."
                                    rows={3}
                                    disabled={isProcessing}
                                />
                                <div className="action-bar">
                                    <button type="button" className="icon-btn" onClick={handleVoiceInput}>
                                        <Mic size={20} color={isListening ? "red" : "white"} />
                                        {isListening ? "Listening..." : "Speak"}
                                    </button>
                                    <button type="button" className="icon-btn secondary">
                                        <ImageIcon size={20} />
                                        Photo
                                    </button>
                                    <button type="submit" className="primary-btn" disabled={isProcessing}>
                                        {isProcessing ? 'Thinking...' : <><Send size={18} /> Save</>}
                                    </button>
                                </div>
                            </form>
                        </div>

                        {therapistNotifications.length > 0 && (
                            <div className="shield-alert">
                                <h3>‚ö†Ô∏è Intervention Required</h3>
                                {therapistNotifications.map((note, idx) => (
                                    <div key={idx} style={{ marginBottom: '10px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <span>{note.message}</span>
                                        <button
                                            onClick={() => handleResolve(note.reminderId)}
                                            style={{ background: '#D63031', color: 'white', border: 'none', padding: '5px 10px', borderRadius: '6px', cursor: 'pointer', fontSize: '0.85rem' }}>
                                            Resolve
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}

                        <div className="reminder-list">
                            <div style={{ marginTop: '20px', borderBottom: '1px solid #eee', paddingBottom: '10px' }}>
                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                                    <h2 style={{ fontSize: '1.1rem', color: '#636E72', margin: 0 }}>
                                        Active Monitoring
                                    </h2>
                                    <span style={{ fontSize: '0.8rem', color: '#B2BEC3' }}>Auto-Pilot Engaged</span>
                                </div>
                                <p style={{ fontSize: '0.85rem', color: '#636E72', marginTop: '8px', lineHeight: '1.4' }}>
                                    <strong>System Logic:</strong> Patients receive 3 auto-reminders. You are alerted <em>only</em> if they fail to respond to all 3, or if unconfirmed 48h before appointment.
                                </p>
                            </div>

                            {reminders.length === 0 && (
                                <div className="empty-state" style={{ textAlign: 'center', color: '#B2BEC3', marginTop: '40px', padding: '30px', background: '#F8F9FA', borderRadius: '12px' }}>
                                    <CheckCircle size={48} style={{ marginBottom: '15px', opacity: 0.5 }} />
                                    <p>System Ready. No active alarms.</p>
                                    <span style={{ fontSize: '0.8rem' }}>Your cognitive load is optimized.</span>
                                </div>
                            )}

                            {reminders.map((r) => (
                                <div key={r.id} className={`reminder-card ${r.status}`}>
                                    <div className="card-header">
                                        <span className="time-badge">{r.time}</span>
                                        <span className={`status-badge ${r.status}`}>{r.status}</span>
                                    </div>
                                    <p className="reminder-text">{r.text}</p>
                                    {r.ai_action && (
                                        <div className="ai-notice">
                                            ü§ñ {r.ai_action}
                                        </div>
                                    )}
                                    <div className="meta-info">
                                        <span>Attempts: {r.attempt_count}/3</span>
                                        <span> | ID: {r.gcal_id}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>